from fastapi import APIRouter, Depends
from starlette.requests import Request
from loguru import logger

from huggingfastapi.core import security
from huggingfastapi.models.payload import AIDetectionPayload
from huggingfastapi.models.prediction import AIDetectionResult
from huggingfastapi.services.nlp import AIDetectionModel

router = APIRouter()



@router.post("/detect-ai", response_model=AIDetectionResult, name="detect-ai")
def post_detect_ai(
    request: Request,
    authenticated: bool = Depends(security.validate_request),
    block_data: AIDetectionPayload = None,
) -> AIDetectionResult:
    """
    #### Detects if text is AI-generated or human-written
    
    Uses the desklib/ai-text-detector-v1.01 model to analyze text and determine
    if it was generated by AI or written by a human.
    
    Returns:
    - probability: Float between 0 and 1 indicating likelihood of AI generation
    - label: 1 for AI-generated, 0 for human-written
    - prediction: Text description of the prediction
    """
    
    ai_model: AIDetectionModel = request.app.state.ai_model
    prediction: AIDetectionResult = ai_model.predict(block_data)

    return prediction
